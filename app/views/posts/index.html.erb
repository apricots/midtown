<div class="search-container">
	<div class="search-collection">
		<div id="pointA"></div>
		<div id="pointB"></div>	
		<div id="pointC"></div>
		<div id="pointD"></div>	
		<%# This is auto generated %>
	</div>

	<div class="friends-container">
		<h3>friends</h3>
		<ul>
			<% for user in current_user.friends %>
				<li>
					<a class="friend-container" href="#" data-username="<%= user.username %>" data-address="<%= user.address %>">
						<div class="friend">
							<div><strong><%= user.username %></strong></div>
							<% if(user.address != nil)  %>
								<div><span><%= user.address %></span></div>
							<% end %>
						</div>
					</a>
				</li>
			<% end %>
		</ul>
	</div>

	<div id="directions"></div>

	<div id="directionsDiv"></div>
</div>

<div class="map-container">
    <div id="Map">
	    <div id="LocateButton"></div>
	</div>
</div>

<script>
	var API_TOKEN = "g-w4YQfNO1dWRhUttjbtey-UEyVWf82XBS6H2LbA4MXrQ5EQAaGdAF6Nig84hr0dffVnDEwgcE-obRRtU-DwioHYk1atWYaAmoINc4VKdyVy6rImdrTBlcLoTwsZqEzpaAW6OH1kxwRDyWryG3LRbg.."

	var geocoders = [];
	var searchContainer = $(".search-collection");

	var map;

  	require([
  		"dojo/dom",
		"dojo/_base/array",
		"esri/Color",
		"dojo/parser",
		"dijit/registry",

		"esri/dijit/Geocoder",
		"esri/dijit/LocateButton",

		"esri/urlUtils",
		"esri/map",
		"esri/lang",
		"esri/graphic",
		"esri/InfoTemplate",
		"esri/layers/GraphicsLayer",
		"esri/renderers/SimpleRenderer",

		"esri/geometry/Point",
		"esri/tasks/FeatureSet",

		"esri/tasks/ClosestFacilityTask",
		"esri/tasks/ClosestFacilityParameters",

		"esri/symbols/SimpleMarkerSymbol",
		"esri/symbols/SimpleLineSymbol",

		"dijit/form/ComboBox",
		"dijit/layout/BorderContainer",
		"dijit/layout/ContentPane"], function(
			dom, array, Color, parser, registry,
			Geocoder, LocateButton,
			urlUtils, Map, esriLang, Graphic, InfoTemplate, GraphicsLayer, SimpleRenderer, 
      		Point, FeatureSet, 
      		ClosestFacilityTask, ClosestFacilityParameters, 
      		SimpleMarkerSymbol, SimpleLineSymbol) {

		var incidentsGraphicsLayer, 
			routeGraphicLayer, 
			facilitiesGraphicsLayer,
			addressGraphicsLayer,
			midpointGraphicsLayer;

		var closestFacilityTask = new ClosestFacilityTask("http://route.arcgis.com/arcgis/rest/services/World/ClosestFacility/NAServer/ClosestFacility_World?token=" + API_TOKEN);

					var dragging = false;

		//wtf does this even do? i don't even know
      	parser.parse();

  		//Create the map so it is pretty for the UI
	    map = new Map("Map", {
	      center: [-56.049, 38.485],
	      zoom: 4,
	      maxZoom:6,
	      minZoom:2,
	      basemap: "streets",
	    });

		map.on("click", mapClickHandler);

	    //Create the geo location button on the map
		var geoLocate = new LocateButton({
        	map: map
      	}, "LocateButton");
      	geoLocate.startup();

		params = new ClosestFacilityParameters();
		params.impedenceAttribute= "Miles";      
		params.defaultCutoff= 100000.0;      
		params.returnIncidents=false;
		params.returnRoutes=true;
		params.returnDirections=true;
		params.defaultTargetFacilityCount=10;
      
		map.on("load", function(evtObj) {
			var map = evtObj.target;
			map.enableScrollWheelZoom();

			//Origin
			incidentsGraphicsLayer = new GraphicsLayer();
	        var incidentPointSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 16, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([89,95,35]), 2), new Color([130,159,83,0.40]));
	        var incidentsRenderer = new SimpleRenderer(incidentPointSymbol);
	        incidentsGraphicsLayer.setRenderer(incidentsRenderer);
	        map.addLayer(incidentsGraphicsLayer);

        	//Route
	        routeGraphicLayer = new GraphicsLayer();
	        var routePolylineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([89,95,35]), 4.0);
	        var routeRenderer = new SimpleRenderer(routePolylineSymbol);
	        routeGraphicLayer.setRenderer(routeRenderer);
	        map.addLayer(routeGraphicLayer);

			//Targets
			facilitiesGraphicsLayer = new GraphicsLayer();
			var facilityPointSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_DIAMOND, 20, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([89,95,35]), 2), new Color([130,159,83,0.40]));
	        var facilityRenderer = new SimpleRenderer(facilityPointSymbol);
	        facilitiesGraphicsLayer.setRenderer(facilityRenderer);
	        map.addLayer(facilitiesGraphicsLayer);

	        //Address
	        addressGraphicsLayer = new GraphicsLayer();
	        var addressPointSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_SQUARE, 20, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([89,95,35]), 2), new Color([130,159,83,0.40]));
			var addressRenderer = new SimpleRenderer(addressPointSymbol);
			addressGraphicsLayer.setRenderer(addressRenderer);
			map.addLayer(addressGraphicsLayer);

			//Midpoint
			midpointGraphicsLayer = new GraphicsLayer();
	        var midpointPointSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_SQUARE, 20, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([33,95,35]), 2), new Color([33,200,35]));
			var midpointRenderer = new SimpleRenderer(midpointPointSymbol);
			midpointGraphicsLayer.setRenderer(midpointRenderer);
			map.addLayer(midpointGraphicsLayer);


	        facilitiesGraphicsLayer.add(new Graphic(new Point(-13625960,8549921,map.spatialReference)));
	        facilitiesGraphicsLayer.add(new Graphic(new Point(-13626184,4549247,map.spatialReference)));
	        facilitiesGraphicsLayer.add(new Graphic(new Point(-13626477,4549415,map.spatialReference)));
	        facilitiesGraphicsLayer.add(new Graphic(new Point(-13625385,4549659,map.spatialReference))); 
	        facilitiesGraphicsLayer.add(new Graphic(new Point(-13624374,4548254,map.spatialReference))); 
	        facilitiesGraphicsLayer.add(new Graphic(new Point(-13624891,4548565,map.spatialReference))); 

	        params.outSpatialReference = map.spatialReference;
       
  		});

		//clear graphics	
      	function clearGraphics() {
	        dom.byId("directionsDiv").innerHTML= "";
	        map.graphics.clear();
	        routeGraphicLayer.clear();
	        incidentsGraphicsLayer.clear();    
		}

      	function mapClickHandler(evt) {
			updateMidpoint(evt.mapPoint.x, evt.mapPoint.y);
      	}

  		//Add Geocoder dynamically
	    var pointA = addGeocoder("pointA", "Your Address", "New York");
	    var pointB = addGeocoder("pointB", "Friends Address", "San Fransisco");
	    var pointB = addGeocoder("pointC", "Friends Address", "North Dakota");
	    var pointB = addGeocoder("pointD", "Friends Address", "Florida");

		$("a.friend-container").each(function() {
			$(this).unbind("click").click(function() {
				var username = $(this).attr("data-username");
				var address = $(this).attr("data-address");
				//Exist
				if($("#point" + username).length) {
					searchContainer.remove("#point" + username);
				}else {
					searchContainer.append('<div id="point' + username + '"></div>');
					var geocoder = addGeocoder("point" + username, username, address);
					geocoder.blur();
				}
				return false;
			});
		});

		function addGeocoder(id, detail, address) {
			var graphic;

			var geocoder = new Geocoder({
				autoComplete: true,
				map: map,
				zoomScale: 2,
	  			arcgisGeocoder: {
	    			placeholder: detail
	  			},
	  			value: address != null ? address : ""
			}, dom.byId(id));

			geocoder.on("select", function(e) {
				var x = e.result.feature.geometry.x;
				var y = e.result.feature.geometry.y;
				graphic = new Graphic(new Point(x, y, map.spatialReference))

				addressGraphicsLayer.add(graphic);
				calculateMidpoint();
			});

			geocoder.on("clear", function() {
				addressGraphicsLayer.remove(graphic);
				calculateMidpoint();
			});

			geocoders.push(geocoder)
			return geocoder;
		}


		function calculateMidpoint() {
			var totalX = 0;
			var totalY = 0;
			var totalCounter = 0;

			for(var i = 0; i < geocoders.length; i++) {
				var currentGeocoder = geocoders[i];
				if(currentGeocoder.results.length > 0) {
					totalX += currentGeocoder.results[0].feature.geometry.x;
					totalY += currentGeocoder.results[0].feature.geometry.y;
					totalCounter++;
				}
			}

			if(totalCounter > 1 && totalX != null && totalY != null) {
				updateMidpoint(totalX/totalCounter, totalY/totalCounter);
			}
		}

		function updateMidpoint(x, y) {
			var midpointPointGraphic = new Graphic(new Point(x, y, map.spatialReference));
			midpointGraphicsLayer.clear();
			midpointGraphicsLayer.add(midpointPointGraphic);
			generateMidpointReverseDirections(midpointPointGraphic);
		}

		function generateMidpointReverseDirections(midpointPoint) {
			var facilities = new FeatureSet();
	        facilities.features = midpointGraphicsLayer.graphics;
	        params.facilities = facilities;

        	var incidents = new FeatureSet();
    		incidents.features = addressGraphicsLayer.graphics
        	params.incidents = incidents;

        	//Mouse handler
			map.graphics.enableMouseEvents();
       
        	routeGraphicLayer.on("mouse-over", function(evt) {
          	//clear existing directions and highlight symbol
          		map.graphics.clear();
          		dom.byId("directionsDiv").innerHTML= "Hover over the route to view directions";
          
          		var highlightSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([0,255,255],0.25), 4.5);
          		var highlightGraphic = new Graphic(evt.graphic.geometry,highlightSymbol);
          
          		map.graphics.add(highlightGraphic);
          		dom.byId("directionsDiv").innerHTML = esriLang.substitute(evt.graphic.attributes,"${*}");
        	});	


        	closestFacilityTask.solve(params, function(solveResult) {
				clearGraphics();

          		var directions = solveResult.directions;

          		array.forEach(solveResult.routes, function(route, index) {


            		//build an array of route info
	            	var attr = array.map(solveResult.directions[index].features, function(feature) {
	              		return feature.attributes.text;
	            	});

	            	var infoTemplate = new InfoTemplate("Attributes", "${*}");
	            
	            	route.setInfoTemplate(infoTemplate);
	            	route.setAttributes(attr);
	            
	            	routeGraphicLayer.add(route);
	            	dom.byId("directionsDiv").innerHTML = "Hover over the route to view directions";
	          	});
          	});
		}


	});     

</script>



